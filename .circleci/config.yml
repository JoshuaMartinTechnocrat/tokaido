version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.10-stretch

    working_directory: /go/src/github.com/ironstar-io/tokaido

    steps:
      - checkout     

      - run: dep ensure
      
      - run: make build-windows
      - run: make build-linux
      - run: make build-osx
      - run: ls dist/

      - store_artifacts:
          path: /go/src/github.com/ironstar-io/tokaido/dist/
          destination: artifacts

      - persist_to_workspace:        
          root: /go/src/github.com/ironstar-io/tokaido/
          paths: 
            - dist

  release-edge:
    docker:
      - image: circleci/golang:1.10-stretch
    environment:
      VERSION: edge      
    steps:
      - attach_workspace:
          at: ./
      - run: go get github.com/tcnksm/ghr      
      - run: 
          name: Create release message
          command: |
            read -r -d '' RELEASE_MESSAGE << EOM
The "edge" releases contain our latest development builds. If you need a 
reliable Tokaido environment, please don't use this version. 

If you want to help us test new features, then please use this branch and be 
sure to submit an Issue telling us if you find any problems.
EOM
      - run:
          name: "Publish Linux Release on GitHub"
          command: ghr -t ${GITHUB_TOKEN} -u ironstar-io -r tokaido -b ${RELEASE_MESSAGE} -c ${CIRCLE_SHA1} -prerelease -delete ${VERSION} ./dist/

workflows:
  version: 2
  build-and-release:
    jobs:
      - build
      - release-edge:
          requires: 
            - build
          filters:
            branches:
              only:               
                - build-system
      # - release-stable:
      #     requires: 
      #       - build
      #     filters:
      #       branches:
      #         only:               
      #           - master
      #       tags:
      #         only: /^v.*/
